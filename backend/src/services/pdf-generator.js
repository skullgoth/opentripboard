// US9: PDF generator service for trip export
import PDFDocument from 'pdfkit';
import { format } from 'date-fns';

/**
 * Generate PDF for a trip itinerary
 * @param {Object} trip - Trip data with activities
 * @param {Array} activities - Trip activities
 * @param {Array} tripBuddies - Trip collaborators
 * @param {Object} options - Additional data (expenses, lists)
 * @returns {Promise<Buffer>} PDF buffer
 */
export async function generateTripPDF(trip, activities, tripBuddies = [], options = {}) {
  const { expenses = [], expenseSummary = null, lists = [] } = options;

  return new Promise((resolve, reject) => {
    try {
      const doc = new PDFDocument({
        size: 'A4',
        margins: { top: 50, bottom: 50, left: 50, right: 50 },
        bufferPages: true,
        info: {
          Title: trip.name,
          Author: 'OpenTripBoard',
          Subject: `Trip Itinerary: ${trip.name}`,
        },
      });

      const chunks = [];
      doc.on('data', (chunk) => chunks.push(chunk));
      doc.on('end', () => resolve(Buffer.concat(chunks)));
      doc.on('error', reject);

      // Page 1: Header and Trip Info
      renderHeader(doc, trip);
      renderTripInfo(doc, trip, tripBuddies);

      // Activities by day (continues on same page, may overflow to new pages)
      renderActivities(doc, trip, activities);

      // Budget & Expenses Page (new page)
      if (trip.budget || (expenses && expenses.length > 0)) {
        doc.addPage();
        renderBudgetPage(doc, trip, expenses, expenseSummary);
      }

      // Lists Page (new page)
      if (lists && lists.length > 0) {
        doc.addPage();
        renderListsPage(doc, lists);
      }

      // Add footers to all pages now that we know the total count
      const range = doc.bufferedPageRange();
      const totalPages = range.count;

      for (let i = 0; i < totalPages; i++) {
        doc.switchToPage(i);

        // Position at bottom of page and add footer
        const footerText = `Generated by OpenTripBoard - Page ${i + 1} of ${totalPages}`;
        doc.fontSize(8).font('Helvetica').fillColor('#9a9a9a');
        const textWidth = doc.widthOfString(footerText);
        const textX = (doc.page.width - textWidth) / 2;

        // Use save/restore to prevent affecting document state
        doc.save();
        doc.text(footerText, textX, doc.page.height - 30, { lineBreak: false });
        doc.restore();
      }

      // Flush all buffered pages before ending
      doc.flushPages();
      doc.end();
    } catch (error) {
      reject(error);
    }
  });
}

/**
 * Render PDF header with trip name
 */
function renderHeader(doc, trip) {
  // Title
  doc
    .fontSize(28)
    .font('Helvetica-Bold')
    .fillColor('#1a1a2e')
    .text(trip.name, { align: 'center' });

  doc.moveDown(0.5);

  // Destination
  if (trip.destination) {
    doc
      .fontSize(16)
      .font('Helvetica')
      .fillColor('#4a4a6a')
      .text(trip.destination, { align: 'center' });
  }

  doc.moveDown(0.3);

  // Dates
  const startDate = trip.start_date ? format(new Date(trip.start_date), 'MMM d, yyyy') : '';
  const endDate = trip.end_date ? format(new Date(trip.end_date), 'MMM d, yyyy') : '';
  if (startDate && endDate) {
    doc
      .fontSize(12)
      .fillColor('#6a6a8a')
      .text(`${startDate} - ${endDate}`, { align: 'center' });
  }

  // Divider
  doc.moveDown(1);
  doc
    .strokeColor('#e0e0e0')
    .lineWidth(1)
    .moveTo(50, doc.y)
    .lineTo(545, doc.y)
    .stroke();

  doc.moveDown(1);
}

/**
 * Render trip information section
 */
function renderTripInfo(doc, trip, tripBuddies) {
  // Budget
  if (trip.budget) {
    doc
      .fontSize(12)
      .font('Helvetica-Bold')
      .fillColor('#1a1a2e')
      .text('Budget: ', { continued: true })
      .font('Helvetica')
      .text(`${trip.currency || 'USD'} ${Number(trip.budget).toLocaleString()}`);
    doc.moveDown(0.5);
  }

  // Trip Buddies
  if (tripBuddies && tripBuddies.length > 0) {
    doc
      .fontSize(12)
      .font('Helvetica-Bold')
      .fillColor('#1a1a2e')
      .text('Trip Buddies: ', { continued: true })
      .font('Helvetica')
      .text(tripBuddies.map((b) => b.full_name || b.email).join(', '));
    doc.moveDown(0.5);
  }

  doc.moveDown(1);
}

/**
 * Render activities grouped by day
 */
function renderActivities(doc, trip, activities) {
  // Section header
  doc
    .fontSize(18)
    .font('Helvetica-Bold')
    .fillColor('#1a1a2e')
    .text('Itinerary');

  doc.moveDown(0.5);

  if (!activities || activities.length === 0) {
    doc
      .fontSize(12)
      .font('Helvetica-Oblique')
      .fillColor('#6a6a8a')
      .text('No activities planned yet.', { align: 'center' });
    return;
  }

  // Group activities by date
  const groupedActivities = groupActivitiesByDate(activities);
  const dates = Object.keys(groupedActivities).sort();

  dates.forEach((date, index) => {
    // Check if we need a new page
    if (doc.y > 680) {
      doc.addPage();
    }

    // Day header
    const dayNumber = index + 1;
    const formattedDate = format(new Date(date), 'EEEE, MMMM d, yyyy');

    doc
      .fontSize(14)
      .font('Helvetica-Bold')
      .fillColor('#2563eb')
      .text(`Day ${dayNumber} - ${formattedDate}`);

    doc.moveDown(0.3);

    // Day divider
    doc
      .strokeColor('#2563eb')
      .lineWidth(2)
      .moveTo(50, doc.y)
      .lineTo(200, doc.y)
      .stroke();

    doc.moveDown(0.5);

    // Activities for this day
    const dayActivities = groupedActivities[date];
    dayActivities.forEach((activity) => {
      renderActivity(doc, activity);
    });

    doc.moveDown(0.5);
  });
}

/**
 * Render a single activity
 */
function renderActivity(doc, activity) {
  // Check if we need a new page
  if (doc.y > 700) {
    doc.addPage();
  }

  const startX = 60;
  const iconSize = 8;

  // Activity type icon (bullet point)
  doc
    .circle(startX, doc.y + 6, iconSize / 2)
    .fillColor(getActivityColor(activity.type))
    .fill();

  // Activity title and time
  const timeStr = activity.start_time
    ? format(new Date(activity.start_time), 'h:mm a')
    : '';

  doc
    .fontSize(12)
    .font('Helvetica-Bold')
    .fillColor('#1a1a2e')
    .text(activity.title, startX + 15, doc.y, { continued: timeStr ? true : false });

  if (timeStr) {
    doc
      .font('Helvetica')
      .fillColor('#6a6a8a')
      .text(` - ${timeStr}`);
  }

  // Activity type badge
  if (activity.type) {
    doc
      .fontSize(9)
      .font('Helvetica')
      .fillColor('#8a8aaa')
      .text(`[${activity.type.toUpperCase()}]`, startX + 15);
  }

  // Location
  if (activity.location || activity.address) {
    doc
      .fontSize(10)
      .font('Helvetica')
      .fillColor('#4a4a6a')
      .text(`ðŸ“ ${activity.address || activity.location}`, startX + 15);
  }

  // Description/Notes
  if (activity.description) {
    doc
      .fontSize(10)
      .font('Helvetica-Oblique')
      .fillColor('#6a6a8a')
      .text(activity.description, startX + 15, doc.y, {
        width: 450,
        lineGap: 2,
      });
  }

  // Reservation info
  if (activity.metadata?.isReservation) {
    const meta = activity.metadata;
    if (meta.confirmationCode) {
      doc
        .fontSize(10)
        .font('Helvetica')
        .fillColor('#059669')
        .text(`âœ“ Confirmation: ${meta.confirmationCode}`, startX + 15);
    }
    if (meta.providerName) {
      doc
        .fontSize(10)
        .font('Helvetica')
        .fillColor('#4a4a6a')
        .text(`Provider: ${meta.providerName}`, startX + 15);
    }
  }

  doc.moveDown(0.8);
}

/**
 * Render Budget & Expenses page
 */
function renderBudgetPage(doc, trip, expenses, summary) {
  // Page title
  doc
    .fontSize(22)
    .font('Helvetica-Bold')
    .fillColor('#1a1a2e')
    .text('Budget & Expenses', { align: 'center' });

  doc.moveDown(1.5);

  // Budget summary box
  if (trip.budget) {
    const currency = trip.currency || 'USD';
    const budget = Number(trip.budget);
    const totalSpent = summary?.totalSpent || 0;
    const remaining = budget - totalSpent;

    // Save current Y position before drawing box
    const boxY = doc.y;

    // Draw box background
    doc
      .rect(50, boxY, 495, 80)
      .fillColor('#f0f9ff')
      .fill();

    // Draw box content
    doc
      .fontSize(14)
      .font('Helvetica-Bold')
      .fillColor('#1a1a2e')
      .text('Budget Overview', 70, boxY + 15);

    doc
      .fontSize(12)
      .font('Helvetica')
      .fillColor('#1a1a2e')
      .text(`Total Budget: ${currency} ${budget.toLocaleString()}`, 70, boxY + 35)
      .text(`Total Spent: ${currency} ${totalSpent.toLocaleString()}`, 70, boxY + 50)
      .fillColor(remaining >= 0 ? '#059669' : '#dc2626')
      .text(`Remaining: ${currency} ${remaining.toLocaleString()}`, 70, boxY + 65);

    // Move Y position below the box
    doc.y = boxY + 95;
  }

  doc.moveDown(1);

  // Expenses by category (byCategory is an array of {category, total} objects)
  if (summary?.byCategory && Array.isArray(summary.byCategory) && summary.byCategory.length > 0) {
    doc
      .fontSize(14)
      .font('Helvetica-Bold')
      .fillColor('#1a1a2e')
      .text('Spending by Category');

    doc.moveDown(0.5);

    const currency = trip.currency || 'USD';
    summary.byCategory.forEach((item) => {
      const amount = Number(item.total) || 0;
      doc
        .fontSize(11)
        .font('Helvetica')
        .fillColor('#4a4a6a')
        .text(`â€¢ ${item.category}: ${currency} ${amount.toLocaleString()}`, 70);
    });

    doc.moveDown(1);
  }

  // Expense list
  if (expenses && expenses.length > 0) {
    doc
      .fontSize(14)
      .font('Helvetica-Bold')
      .fillColor('#1a1a2e')
      .text('Expense Details');

    doc.moveDown(0.5);

    // Table header
    const tableY = doc.y;
    doc
      .fontSize(10)
      .font('Helvetica-Bold')
      .fillColor('#6a6a8a')
      .text('Date', 50, tableY)
      .text('Description', 120, tableY)
      .text('Category', 320, tableY)
      .text('Amount', 420, tableY, { align: 'right', width: 75 });

    doc.moveDown(0.3);
    doc
      .strokeColor('#e0e0e0')
      .lineWidth(1)
      .moveTo(50, doc.y)
      .lineTo(545, doc.y)
      .stroke();

    doc.moveDown(0.3);

    const currency = trip.currency || 'USD';
    expenses.slice(0, 30).forEach((expense) => {
      if (doc.y > 720) {
        doc.addPage();
      }

      const rowY = doc.y;
      const expenseDate = expense.expense_date
        ? format(new Date(expense.expense_date), 'MMM d')
        : '-';

      doc
        .fontSize(9)
        .font('Helvetica')
        .fillColor('#1a1a2e')
        .text(expenseDate, 50, rowY, { width: 60 })
        .text(expense.description || '-', 120, rowY, { width: 190 })
        .text(expense.category || '-', 320, rowY, { width: 90 })
        .text(`${currency} ${Number(expense.amount).toLocaleString()}`, 420, rowY, { align: 'right', width: 75 });

      doc.moveDown(0.5);
    });

    if (expenses.length > 30) {
      doc
        .fontSize(9)
        .font('Helvetica-Oblique')
        .fillColor('#6a6a8a')
        .text(`... and ${expenses.length - 30} more expenses`, { align: 'center' });
    }
  }
}

/**
 * Render Lists page
 */
function renderListsPage(doc, lists) {
  // Page title
  doc
    .fontSize(22)
    .font('Helvetica-Bold')
    .fillColor('#1a1a2e')
    .text('Packing & Custom Lists', { align: 'center' });

  doc.moveDown(1);

  lists.forEach((list) => {
    if (doc.y > 650) {
      doc.addPage();
    }

    // List header - use 'title' field (not 'name')
    const items = list.items || [];
    const checkedCount = items.filter((i) => i.checked).length;
    const progress = items.length > 0 ? Math.round((checkedCount / items.length) * 100) : 0;

    doc
      .fontSize(14)
      .font('Helvetica-Bold')
      .fillColor('#1a1a2e')
      .text(list.title || 'Untitled List', { continued: true })
      .font('Helvetica')
      .fontSize(11)
      .fillColor('#6a6a8a')
      .text(`  (${checkedCount}/${items.length} - ${progress}%)`);

    doc.moveDown(0.3);

    // List items - use 'text' field (not 'name')
    if (items.length > 0) {
      items.forEach((item) => {
        if (doc.y > 720) {
          doc.addPage();
        }

        // Use ASCII checkboxes since Unicode ones aren't supported by Helvetica
        const checkbox = item.checked ? '[x]' : '[ ]';
        doc
          .fontSize(10)
          .font('Helvetica')
          .fillColor(item.checked ? '#059669' : '#4a4a6a')
          .text(`  ${checkbox} ${item.text || item.name || 'Unnamed item'}`, 60);
      });
    } else {
      doc
        .fontSize(10)
        .font('Helvetica-Oblique')
        .fillColor('#8a8aaa')
        .text('  No items in this list', 60);
    }

    doc.moveDown(1);
  });
}

/**
 * Render PDF footer on all pages
 * Note: This must be called right before doc.end() and uses low-level text rendering
 * to avoid creating extra pages
 */
function renderFooter(doc) {
  const range = doc.bufferedPageRange();
  const pageCount = range.count;

  for (let i = 0; i < pageCount; i++) {
    doc.switchToPage(i);

    // Use low-level text rendering to avoid affecting page flow
    const footerText = `Generated by OpenTripBoard - Page ${i + 1} of ${pageCount}`;
    const footerY = doc.page.height - 30;
    const pageWidth = doc.page.width;

    // Calculate text width for centering
    doc.fontSize(8).font('Helvetica');
    const textWidth = doc.widthOfString(footerText);
    const textX = (pageWidth - textWidth) / 2;

    // Draw text directly without using text() which can affect flow
    doc
      .fillColor('#9a9a9a')
      .text(footerText, textX, footerY, { lineBreak: false, continued: false });
  }

  // Switch back to last page to prevent issues with doc.end()
  if (pageCount > 0) {
    doc.switchToPage(pageCount - 1);
  }
}

/**
 * Group activities by date
 */
function groupActivitiesByDate(activities) {
  return activities.reduce((groups, activity) => {
    // Extract date from start_time timestamp
    const timestamp = activity.start_time;
    if (!timestamp) return groups;

    // Parse the timestamp and get just the date part
    const dateObj = new Date(timestamp);
    const dateKey = format(dateObj, 'yyyy-MM-dd');

    if (!groups[dateKey]) {
      groups[dateKey] = [];
    }
    groups[dateKey].push(activity);

    // Sort by time within each day
    groups[dateKey].sort((a, b) => {
      const timeA = a.start_time ? new Date(a.start_time).getTime() : 0;
      const timeB = b.start_time ? new Date(b.start_time).getTime() : 0;
      return timeA - timeB;
    });

    return groups;
  }, {});
}

/**
 * Get color for activity type
 */
function getActivityColor(type) {
  const colors = {
    activity: '#2563eb',
    restaurant: '#dc2626',
    hotel: '#7c3aed',
    flight: '#0891b2',
    train: '#65a30d',
    car: '#ea580c',
    museum: '#be185d',
    attraction: '#4f46e5',
    shopping: '#c026d3',
    entertainment: '#e11d48',
    default: '#6b7280',
  };

  return colors[type] || colors.default;
}
